# Nombre de la action
name: Build container and run VISE API testing

# Se ejecuta manualmente desde GitHub Actions
on:
  workflow_dispatch:
    inputs:
      PORT:
        description: 'The port of your application'
        required: true
        default: "3000"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸ Descarga del cÃ³digo fuente
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸ Configurar Docker
      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      # 3ï¸ Construir imagen del contenedor
      - name: Build Docker image
        run: |
          echo "ğŸ”§ Building Docker image..."
          docker build -t vise-api:latest .

      # 4ï¸ Ejecutar contenedor y esperar a que arranque
      - name: Run container
        run: |
          echo "ğŸš€ Starting container..."
          docker run -d -p ${{ github.event.inputs.PORT }}:${{ github.event.inputs.PORT }} --name vise-api vise-api:latest
          echo "â³ Waiting for container to initialize..."
          sleep 8
          docker ps

      # 5ï¸ Instalar Hurl (herramienta de pruebas HTTP)
      - name: Setup Hurl (API testing tool)
        uses: gacts/install-hurl@v1

      # 6ï¸ Ejecutar las pruebas Hurl
      - name: Run Hurl tests
        run: |
          echo "ğŸ§ª Running API tests..."
          set -e  # Detiene el job si alguna prueba falla
          hurl --test --variable PORT=${{ github.event.inputs.PORT }} tests.hurl || (echo "âŒ Some tests failed!" && exit 1)
          echo "âœ… All tests passed successfully!"

      # 7ï¸ Detener y limpiar el contenedor (siempre se ejecuta)
      - name: Stop container
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker stop vise-api || true
          docker rm vise-api || true
